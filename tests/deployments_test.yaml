suite: test deployments
templates:
  - deployments.yaml
tests:
  - it: should create expected deployments minimal
    asserts:
      - isKind:
          of: Deployment
      - hasDocuments:
          count: 5
      - equal:
          path: metadata
          value:
            name: attendee-service
            labels:
              app: regsys
              service: attendee-service
              regsysChart: https://github.com/eurofurence/reg-helm-chart
        documentIndex: 0
      - equal:
          path: spec
          value:
            replicas: 1
            revisionHistoryLimit: 3
            selector:
              matchLabels:
                app: regsys
                service: attendee-service
                regsysChart: https://github.com/eurofurence/reg-helm-chart
            template:
              metadata:
                labels:
                  app: regsys
                  service: attendee-service
                  regsysChart: https://github.com/eurofurence/reg-helm-chart
              spec:
                containers:
                  - name: application
                    image: 'ghcr.io/eurofurence/reg-attendee-service:latest'
                    ports:
                      - containerPort: 8080
                        name: primary
                    readinessProbe:
                      httpGet:
                        port: primary
                        path: /
                      initialDelaySeconds: 2
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                    resources:
                      limits:
                        memory: 256Mi
                    securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                        drop:
                          - ALL
                    command: [/main]
                    args:
                      - --config=/config/config.yaml
                      - --migrate-database
                    env:
                      - name: REG_SECRET_DB_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_DB_PASSWORD
                      - name: REG_SECRET_API_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_API_TOKEN
                    volumeMounts:
                      - name: config-file
                        mountPath: /config
                        readOnly: true
                volumes:
                  - name: config-file
                    configMap:
                      name: regsys-cm
                      items:
                        - key: attendee-service-config
                          path: config.yaml
                          mode: 0444
        documentIndex: 0
      - equal:
          path: metadata
          value:
            name: auth-service
            labels:
              app: regsys
              service: auth-service
              regsysChart: https://github.com/eurofurence/reg-helm-chart
        documentIndex: 1
      - equal:
          path: spec
          value:
            replicas: 1
            revisionHistoryLimit: 3
            selector:
              matchLabels:
                app: regsys
                service: auth-service
                regsysChart: https://github.com/eurofurence/reg-helm-chart
            template:
              metadata:
                labels:
                  app: regsys
                  service: auth-service
                  regsysChart: https://github.com/eurofurence/reg-helm-chart
              spec:
                containers:
                  - name: application
                    image: 'ghcr.io/eurofurence/reg-auth-service:latest'
                    ports:
                      - containerPort: 8080
                        name: primary
                    readinessProbe:
                      httpGet:
                        port: primary
                        path: /
                      initialDelaySeconds: 2
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                    resources:
                      limits:
                        memory: 256Mi
                    securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                        drop:
                          - ALL
                    command: [/main]
                    args:
                      - --config=/config/config.yaml
                    env:
                      - name: REG_SECRET_OIDC_CLIENT_ID
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_OIDC_CLIENT_ID
                      - name: REG_SECRET_OIDC_CLIENT_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_OIDC_CLIENT_SECRET
                    volumeMounts:
                      - name: config-file
                        mountPath: /config
                        readOnly: true
                volumes:
                  - name: config-file
                    configMap:
                      name: regsys-cm
                      items:
                        - key: auth-service-config
                          path: config.yaml
                          mode: 0444
        documentIndex: 1
      - equal:
          path: metadata
          value:
            name: mail-service
            labels:
              app: regsys
              service: mail-service
              regsysChart: https://github.com/eurofurence/reg-helm-chart
        documentIndex: 2
      - equal:
          path: spec
          value:
            replicas: 1
            revisionHistoryLimit: 3
            selector:
              matchLabels:
                app: regsys
                service: mail-service
                regsysChart: https://github.com/eurofurence/reg-helm-chart
            template:
              metadata:
                labels:
                  app: regsys
                  service: mail-service
                  regsysChart: https://github.com/eurofurence/reg-helm-chart
              spec:
                containers:
                  - name: application
                    image: 'ghcr.io/eurofurence/reg-mail-service:latest'
                    ports:
                      - containerPort: 8080
                        name: primary
                    readinessProbe:
                      httpGet:
                        port: primary
                        path: /
                      initialDelaySeconds: 2
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                    resources:
                      limits:
                        memory: 256Mi
                    securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                        drop:
                          - ALL
                    command: [/main]
                    args:
                      - --config=/config/config.yaml
                      - --migrate-database
                    env:
                      - name: REG_SECRET_SMTP_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_SMTP_PASSWORD
                      - name: REG_SECRET_DB_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_DB_PASSWORD
                      - name: REG_SECRET_API_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_API_TOKEN
                    volumeMounts:
                      - name: config-file
                        mountPath: /config
                        readOnly: true
                volumes:
                  - name: config-file
                    configMap:
                      name: regsys-cm
                      items:
                        - key: mail-service-config
                          path: config.yaml
                          mode: 0444
        documentIndex: 2
      - equal:
          path: metadata
          value:
            name: payment-cncrd-adapter
            labels:
              app: regsys
              service: payment-cncrd-adapter
              regsysChart: https://github.com/eurofurence/reg-helm-chart
        documentIndex: 3
      - equal:
          path: spec
          value:
            replicas: 1
            revisionHistoryLimit: 3
            selector:
              matchLabels:
                app: regsys
                service: payment-cncrd-adapter
                regsysChart: https://github.com/eurofurence/reg-helm-chart
            template:
              metadata:
                labels:
                  app: regsys
                  service: payment-cncrd-adapter
                  regsysChart: https://github.com/eurofurence/reg-helm-chart
              spec:
                containers:
                  - name: application
                    image: 'ghcr.io/eurofurence/reg-payment-cncrd-adapter:latest'
                    ports:
                      - containerPort: 8080
                        name: primary
                    readinessProbe:
                      httpGet:
                        port: primary
                        path: /
                      initialDelaySeconds: 2
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                    resources:
                      limits:
                        memory: 256Mi
                    securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                        drop:
                          - ALL
                    command: [/main]
                    args:
                      - --config=/config/config.yaml
                    env:
                      - name: REG_SECRET_CONCARDIS_API_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_CONCARDIS_API_SECRET
                      - name: REG_SECRET_API_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_API_TOKEN
                      - name: REG_SECRET_CONCARDIS_INCOMING_WEBHOOK_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_CONCARDIS_INCOMING_WEBHOOK_SECRET
                    volumeMounts:
                      - name: config-file
                        mountPath: /config
                        readOnly: true
                volumes:
                  - name: config-file
                    configMap:
                      name: regsys-cm
                      items:
                        - key: payment-cncrd-adapter-config
                          path: config.yaml
                          mode: 0444
        documentIndex: 3
      - equal:
          path: metadata
          value:
            name: payment-service
            labels:
              app: regsys
              service: payment-service
              regsysChart: https://github.com/eurofurence/reg-helm-chart
        documentIndex: 4
      - equal:
          path: spec
          value:
            replicas: 1
            revisionHistoryLimit: 3
            selector:
              matchLabels:
                app: regsys
                service: payment-service
                regsysChart: https://github.com/eurofurence/reg-helm-chart
            template:
              metadata:
                labels:
                  app: regsys
                  service: payment-service
                  regsysChart: https://github.com/eurofurence/reg-helm-chart
              spec:
                containers:
                  - name: application
                    image: 'ghcr.io/eurofurence/reg-payment-service:latest'
                    ports:
                      - containerPort: 8080
                        name: primary
                    readinessProbe:
                      httpGet:
                        port: primary
                        path: /
                      initialDelaySeconds: 2
                      periodSeconds: 10
                      successThreshold: 1
                      timeoutSeconds: 1
                    resources:
                      limits:
                        memory: 256Mi
                    securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                        drop:
                          - ALL
                    command: [/main]
                    args:
                      - --config=/config/config.yaml
                      - --migrate-database
                    env:
                      - name: REG_SECRET_DB_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_DB_PASSWORD
                      - name: REG_SECRET_API_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: regsys-secret
                            key: REG_SECRET_API_TOKEN
                    volumeMounts:
                      - name: config-file
                        mountPath: /config
                        readOnly: true
                volumes:
                  - name: config-file
                    configMap:
                      name: regsys-cm
                      items:
                        - key: payment-service-config
                          path: config.yaml
                          mode: 0444
        documentIndex: 4

  - it: should not set namespace if unset
    asserts:
      - notExists:
          path: metadata.namespace
  - it: should set namespace if specified
    set:
      global:
        namespace: hellospace
    asserts:
      - equal:
          path: metadata.namespace
          value: hellospace
